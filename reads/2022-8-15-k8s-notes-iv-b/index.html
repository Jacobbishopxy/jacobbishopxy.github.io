<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta content="width=device-width, initial-scale=1" name="viewport" />
		<meta content="#ffffff" name="theme-color" />
		<meta content="#da532c" name="msapplication-TileColor" />

		
		<link href="&#x2F;icons&#x2F;site.webmanifest" rel="manifest" />
		 
		<link
			color="#5bbad5"
			href="&#x2F;icons&#x2F;safari-pinned-tab.svg"
			rel="mask-icon"
		/>
		 
		<link
			href="&#x2F;icons&#x2F;favicon-16x16.png"
			rel="icon"
			sizes="16x16"
			type="image/png"
		/>
		 
		<link
			href="&#x2F;icons&#x2F;favicon-32x32.png"
			rel="icon"
			sizes="32x32"
			type="image/png"
		/>
		 
		<link
			href="&#x2F;icons&#x2F;apple-touch-icon.png"
			rel="apple-touch-icon"
			sizes="180x180"
		/>
		  

		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css"
			integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6"
			crossorigin="anonymous"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"
			integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm"
			crossorigin="anonymous"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
			integrity="sha256-rTpdO0HXBCNpreAHcu6tB2Ppg515Vo+5GtYSsnNLz+8="
			crossorigin="anonymous"
		/>
		<link href="https://jacobbishopxy.github.io/deep-thought.css" rel="stylesheet" />
		<link href="https://jacobbishopxy.github.io/custom.css" rel="stylesheet" />
		 

		<title> Jacob&#x27;s Domain | K8s 笔记 (IV) 下 </title>

		   
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
			integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs"
			crossorigin="anonymous"
		/>
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
			integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx"
			crossorigin="anonymous"
		></script>

		<script
			defer
			src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js"
			integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT"
			crossorigin="anonymous"
		></script>
		
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
			integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
			crossorigin="anonymous"
		></script>
		 
	</head>

	<body class="has-background-white">
		<nav
			aria-label="section navigation"
			class="navbar is-light"
			role="navigation"
		>
			<div class="container">
				<div class="navbar-brand">
					<a
						class="navbar-item is-size-5 has-text-weight-bold"
						href="https:&#x2F;&#x2F;jacobbishopxy.github.io"
						>Jacob&#x27;s Domain</a
					>
					<a
						aria-expanded="false"
						aria-label="menu"
						class="navbar-burger burger"
						data-target="navMenu"
						role="button"
					>
						<span aria-hidden="true"></span>
						<span aria-hidden="true"></span>
						<span aria-hidden="true"></span>
					</a>
				</div>
				<div class="navbar-menu" id="navMenu">
					<div class="navbar-end has-text-centered">
						  
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;"
						>
							Home
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;posts"
						>
							Posts
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;docs"
						>
							Docs
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;reads"
						>
							Reads
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;archives"
						>
							Archives
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;tags"
						>
							Tags
						</a>
						
						<a
							class="navbar-item has-text-weight-semibold"
							href="https:&#x2F;&#x2F;jacobbishopxy.github.io&#x2F;categories"
						>
							Categories
						</a>
						  
						<a
							class="navbar-item"
							id="nav-search"
							title="Search"
							data-target="#search-modal"
						>
							<span class="icon">
								<i class="fas fa-search"></i>
							</span>
						</a>
						<a class="navbar-item" id="dark-mode" title="Switch to dark theme">
							<span class="icon">
								<i class="fas fa-adjust"></i>
							</span>
						</a>
					</div>
				</div>
			</div>
		</nav>

		  
<section class="section">
	<div class="container">
		<div class="columns">
			<div class="column is-8 is-offset-2">
				<article class="box">
					<h1 class="title">K8s 笔记 (IV) 下</h1>
					<p class="subtitle">工作负载（负载资源）</p>
					<div class="columns is-multiline is-gapless">
						<div class="column is-8">
							
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Jacob Xie published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2022-08-15">August 15, 2022</time></span>
</span>

						</div>
						<div class="column is-4 has-text-right-desktop">
							
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>42 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>8356 words</span>
</span>

						</div>
						<div class="column">
							 
<p>
  Categories:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://jacobbishopxy.github.io/categories/read/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>Read</span>
    </span>
  </a>
  
</p>
 
						</div>
						<div class="column has-text-right-desktop">
							 
<p>
  Tags:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://jacobbishopxy.github.io/tags/k8s/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-tag"></i>
      </span>
      <span>k8s</span>
    </span>
  </a>
  
</p>
 
						</div>
					</div>
					<div class="content mt-2"><h2 id="deployments">Deployments</h2>
<p>一个 Deployment 为 Pods 与 ReplicaSets 提供了声明式的更新。</p>
<p>在一个 Deployment 中用户描述一个<em>期望的状态</em>，接着 Deployment 控制器通过速度控制改变现有状态至期望状态。用户可以定义 Deployments 来创建新的 ReplicaSets，或者移除现有的 Deployments 并通过新的 Deployments 继承它们的资源。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>不要管理由 Deployment 所属的 ReplicaSets。</p>

</blockquote>
<h3 id="shi-yong-an-li">使用案例</h3>
<p>以下是 Deployments 的典型使用案例：</p>
<ul>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#CreatingADeployment">创建一个 Deployment 以将 ReplicaSet 上线</a>。ReplicaSet 在后台创建 Pods。检查上线状态确认其成功与否。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#UpdatingADeployment">通过更新 Deployment 的 Pod 模版声明一个 Pods 的新状态</a>。一个新的 ReplicaSet 被创建，并且 Deployment 控速从旧的 ReplicaSet 移动 Pods 至新的。每个新的 ReplicaSet 都会更新 Deployment 的修订版本。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#RollingBackADeployment">回滚到较早之前的 Deployment 版本</a>，如果当前状态的 Deployment 并不稳定。每次回滚都会更新 Deployment 的修订版本。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#ScalingADeployment">扩大 Deployment 规模用以承担更多负载</a>。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#PausingAndResumingADeployment">暂停 Deployment</a> 用以修复若干 Pod 模板，并恢复开始一个新的上线过程。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#DeploymentStatus">使用 Deployment 状态</a>判断上线过程是否出现停滞。</p>
</li>
<li>
<p><a href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#CleanUpPolicy">清理较旧的不再需要的 ReplicaSet</a>。</p>
</li>
</ul>
<h4 id="CreatingADeployment">创建 Deployment</h4>
<p>以下是一个 Deployment 的例子。它创建了一个 ReplicaSet 负责启动三个 <code>nginx</code> Pods：</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">apiVersion</span><span>: </span><span style="color:#a3be8c;">apps/v1
</span><span style="color:#bf616a;">kind</span><span>: </span><span style="color:#a3be8c;">Deployment
</span><span style="color:#bf616a;">metadata</span><span>:
</span><span>  </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">nginx-deployment
</span><span>  </span><span style="color:#bf616a;">labels</span><span>:
</span><span>    </span><span style="color:#bf616a;">app</span><span>: </span><span style="color:#a3be8c;">nginx
</span><span style="color:#bf616a;">spec</span><span>:
</span><span>  </span><span style="color:#bf616a;">replicas</span><span>: </span><span style="color:#d08770;">3
</span><span>  </span><span style="color:#bf616a;">selector</span><span>:
</span><span>    </span><span style="color:#bf616a;">matchLabels</span><span>:
</span><span>      </span><span style="color:#bf616a;">app</span><span>: </span><span style="color:#a3be8c;">nginx
</span><span>  </span><span style="color:#bf616a;">template</span><span>:
</span><span>    </span><span style="color:#bf616a;">metadata</span><span>:
</span><span>      </span><span style="color:#bf616a;">labels</span><span>:
</span><span>        </span><span style="color:#bf616a;">app</span><span>: </span><span style="color:#a3be8c;">nginx
</span><span>    </span><span style="color:#bf616a;">spec</span><span>:
</span><span>      </span><span style="color:#bf616a;">containers</span><span>:
</span><span>        - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">nginx
</span><span>          </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">nginx:1.14.2
</span><span>          </span><span style="color:#bf616a;">ports</span><span>:
</span><span>            - </span><span style="color:#bf616a;">containerPort</span><span>: </span><span style="color:#d08770;">80
</span></code></pre>
<p>这个例子中：</p>
<ul>
<li>
<p>名为 <code>nginx-deployment</code> 的 Deployment 被创建了，由字段 <code>.metadata.name</code> 字段表明。</p>
</li>
<li>
<p>Deployment 创建了三个 Pods 副本，由字段 <code>.spec.replicas</code> 字段表明。</p>
</li>
<li>
<p><code>.spec.selector</code> 字段定义 Deployment 如何寻找 Pods 来管理。在这里，选择在 Pod 模版中定义的标签（<code>app: nginx</code>）。不过更复杂的选择规则也是可能得，只要 Pod 模板本身满足所给的规则即可。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p><code>spec.selector.matchLabels</code> 字段是一个键值对映射。在 <code>matchLabels</code> 映射中的每个 <code>{key, value}</code> 映射等效于 <code>matchExpressions</code> 中的一个元素，即其 <code>key</code> 字段是 ”key“，<code>operator</code> 为 &quot;In&quot;，<code>values</code> 数组仅包含 ”value“。在 <code>matchLabels</code> 和 <code>matchExpressions</code> 中给出的所有条件都必须满足才能匹配。</p>

</blockquote>
</li>
<li>
<p><code>template</code> 字段包含以下子字段：</p>
<ul>
<li>Pod 被标记为 <code>app: nginx</code> 使用 <code>.metadata.labels</code> 字段。</li>
<li>Pod 模版规约，或者 <code>.template.spec</code> 字段，说明 Pods 运行在一个容器, <code>nginx</code>，运行 <code>nginx</code> Docker Hub 的 1.14.2 版本的镜像。</li>
<li>创建一个容器并命名为 <code>nginx</code> 使用 <code>.spec.template.spec.containers[0].name</code> 字段。</li>
</ul>
</li>
</ul>
<p>在开始前，请确保 k8s 集群启动并正常运行中。根据下面步骤来创建上述的 Deployment：</p>
<ol>
<li>
<p>通过执行下面命令创建 Deployment：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> apply</span><span style="color:#bf616a;"> -f</span><span> https://k8s.io/examples/controllers/nginx-deployment.yaml
</span></code></pre>
</li>
<li>
<p>运行 <code>kubectl get deployments</code> 检查 Deployment 是否被创建。如果 Deployment 仍然在被创建，那么会有以下输出：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment   0/3     0            0           1s
</span></code></pre>
<p>当用户检查集群中的 Deployments 会显示下列字段：</p>
<ul>
<li><code>NAME</code> 例出集群中 Deployment 的名称。</li>
<li><code>READY</code> 展示应用程序有多少个副本可用。它遵照 ready/desired 模式。</li>
<li><code>UP-TO-DATE</code> 展示已经被更新到期望状态的副本数量。</li>
<li><code>AVAILABLE</code> 展示应用可供用户使用的副本数。</li>
<li><code>AGE</code> 显示应用程序运行的时间。</li>
</ul>
</li>
<li>
<p>查看 Deployment 的上线状态，运行 <code>kubectl rollout status deployment/nginx-deployment</code>。</p>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
</span><span>deployment &quot;nginx-deployment&quot; successfully rolled out
</span></code></pre>
</li>
<li>
<p>几秒过后再次运行 <code>kubectl get deployments</code>。输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment   3/3     3            3           18s
</span></code></pre>
<p>注意 Deployment 已经创建了三个副本，并且所有副本都已经 up-to-date （它们包含了最新的 Pod 模板）并且可用了。</p>
</li>
<li>
<p>查看由 Deployment 创建的 ReplicaSet（<code>rs</code>），运行 <code>kubectl get rs</code>。输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span><span>nginx-deployment-75675f5897   3         3         3       18s
</span></code></pre>
<p>ReplicaSet 显示下列字段：</p>
<ul>
<li><code>NAME</code> 列出 ReplicaSet 的名称。</li>
<li><code>DESIRED</code> 展示应用所期望数量的<em>副本</em>。</li>
<li><code>CURRENT</code> 展示正在运行的副本数量。</li>
<li><code>READY</code> 展示应用可供用户使用的副本数。</li>
<li><code>AGE</code> 展示应用已经运行的时间。</li>
</ul>
</li>
<li>
<p>查看每个 Pod 所自动创建的标签，运行 <code>kubectl get pods --show-labels</code>。输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                                READY     STATUS    RESTARTS   AGE       LABELS
</span><span>nginx-deployment-75675f5897-7ci7o   1/1       Running   0          18s       app=nginx,pod-template-hash=3123191453
</span><span>nginx-deployment-75675f5897-kzszj   1/1       Running   0          18s       app=nginx,pod-template-hash=3123191453
</span><span>nginx-deployment-75675f5897-qqcnn   1/1       Running   0
</span></code></pre>
<p>创建好的 ReplicaSet 确保拥有三个 <code>nginx</code> Pods。</p>
</li>
</ol>
<h3 id="UpdatingADeployment">更新 Deployment</h3>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>Deployment 的上线仅且仅当 Deployment 的 Pod 模板（即 <code>.spec.template</code>）被更新时才会被触发，例如标签或模板的镜像被更新。其余的更新，例如扩展 Deployment 不会触发上线过程。</p>

</blockquote>
<p>以下步骤更新 Deployment：</p>
<ol>
<li>
<p>更新 nginx Pods 使用 <code>nginx:1.16.1</code> 镜像而不是 <code>nginx:1.14.2</code> 镜像。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> set image deployment.v1.apps/nginx-deployment nginx=nginx:1.16.1
</span></code></pre>
<p>或者：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> set image deployment/nginx-deployment nginx=nginx:1.16.1
</span></code></pre>
<p>将会输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment image updated
</span></code></pre>
<p>另一种方式是通过 <code>edit</code> Deployment 修改 <code>.spec.template.spec.containers[0].image</code> 使 <code>nginx:1.14.2</code> 变为 <code>nginx:1.16.1</code>：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> edit deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment edited
</span></code></pre>
</li>
<li>
<p>检查上线状态，运行：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout status deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Waiting for rollout to finish: 2 out of 3 new replicas have been updated...
</span></code></pre>
<p>或者：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment &quot;nginx-deployment&quot; successfully rolled out
</span></code></pre>
<p>获取更多更新后的 Deployment 细节：</p>
<ul>
<li>
<p>当上线成功，用户可以通过 <code>kubectl get deployments</code> 检查 Deployment。输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment   3/3     3            3           36s
</span></code></pre>
</li>
<li>
<p>运行 <code>kubectl get rs</code> 查看 Deployment 通过创建新的 ReplicaSet 并将其扩容到 3 个副本并将旧 ReplicaSet 缩容到 0 个副本完成了 Pod 的更新操作，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span><span>nginx-deployment-1564180365   3         3         3       6s
</span><span>nginx-deployment-2035384211   0         0         0       36s
</span></code></pre>
</li>
<li>
<p>运行 <code>kubectl get pods</code> 现在应该只展示新 Pods，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                                READY     STATUS    RESTARTS   AGE
</span><span>nginx-deployment-1564180365-khku8   1/1       Running   0          14s
</span><span>nginx-deployment-1564180365-nacti   1/1       Running   0          14s
</span><span>nginx-deployment-1564180365-z9gth   1/1       Running   0
</span></code></pre>
<p>下一次更新这些 Pods 时，用户只需要再次更新 Deployment 的 Pod 模板。</p>
<p>Deployment 确保在 Pods 更新时只有一定数量的 Pods 关闭。默认情况下，它确保至少 75% 的预期数量的 Pods 处于运行状态（25% 最大不可用）。</p>
</li>
<li>
<p>运行 <code>kubectl describe deployments</code> 获取 Deployment 的详细信息，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Name:                   nginx-deployment
</span><span>Namespace:              default
</span><span>CreationTimestamp:      Thu, 30 Nov 2017 10:56:25 +0000
</span><span>Labels:                 app=nginx
</span><span>Annotations:            deployment.kubernetes.io/revision=2
</span><span>Selector:               app=nginx
</span><span>Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
</span><span>StrategyType:           RollingUpdate
</span><span>MinReadySeconds:        0
</span><span>RollingUpdateStrategy:  25% max unavailable, 25% max surge
</span><span>Pod Template:
</span><span>  Labels:  app=nginx
</span><span>  Containers:
</span><span>    nginx:
</span><span>      Image:        nginx:1.16.1
</span><span>      Port:         80/TCP
</span><span>      Environment:  &lt;none&gt;
</span><span>      Mounts:       &lt;none&gt;
</span><span>    Volumes:        &lt;none&gt;
</span><span>  Conditions:
</span><span>    Type           Status  Reason
</span><span>    ----           ------  ------
</span><span>    Available      True    MinimumReplicasAvailable
</span><span>    Progressing    True    NewReplicaSetAvailable
</span><span>  OldReplicaSets:  &lt;none&gt;
</span><span>  NewReplicaSet:   nginx-deployment-1564180365 (3/3 replicas created)
</span><span>  Events:
</span><span>    Type    Reason             Age   From                   Message
</span><span>    ----    ------             ----  ----                   -------
</span><span>    Normal  ScalingReplicaSet  2m    deployment-controller  Scaled up replica set nginx-deployment-2035384211 to 3
</span><span>    Normal  ScalingReplicaSet  24s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 1
</span><span>    Normal  ScalingReplicaSet  22s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 2
</span><span>    Normal  ScalingReplicaSet  22s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 2
</span><span>    Normal  ScalingReplicaSet  19s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 1
</span><span>    Normal  ScalingReplicaSet  19s   deployment-controller  Scaled up replica set nginx-deployment-1564180365 to 3
</span><span>    Normal  ScalingReplicaSet  14s   deployment-controller  Scaled down replica set nginx-deployment-2035384211 to 0
</span></code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="RollingBackADeployment">回滚 Deployment</h3>
<p>有时可能需要回滚一个 Deployment；例如当 Deployment 不稳定时导致的循环崩溃。默认情况下，所有的 Deployment 的回滚历史都会保存在系统中使得可以任何时候回滚（可以修改修订版本的历史限制）。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>一个 Deployment 的修订版本会在 Deployment 回滚触发时创建。这意味着只有修改 Deployment Pod 模板（<code>.spec.template</code>）改变后，新的修订版本才会被创建。其它的更新，例如扩展 Deployment，不会创建 Deployment 修订版本，因此用户可以同时执行手动缩放或自动缩放。换言之，当回滚到较早的修订版本时，只有 Deployment 的 Pod 模板部分会被回滚。</p>

</blockquote>
<ul>
<li>
<p>假设在更新 Deployment 时有一个 typo，把镜像的名称写成了 <code>nginx:1.161</code> 而不是 <code>nginx:1.16.1</code>：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> set image deployment/nginx-deployment nginx=nginx:1.161
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">deployment.apps/nginx-deployment</span><span> image updated
</span></code></pre>
</li>
<li>
<p>这个上线进程会停滞。可以通过命令检查上线状态：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout status deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Waiting for rollout to finish: 1 out of 3 new replicas have been updated...
</span></code></pre>
</li>
<li>
<p>Ctrl-C 结束状态查看。</p>
</li>
<li>
<p>可以看到旧副本（<code>nginx-deployment-1564180365</code> 和 <code>nginx-deployment-2035384211</code>）的数量是 2，新副本（<code>nginx-deployment-3066724191</code>）的数量是 1.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> get rs
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                          DESIRED   CURRENT   READY   AGE
</span><span>nginx-deployment-1564180365   3         3         3       25s
</span><span>nginx-deployment-2035384211   0         0         0       36s
</span><span>nginx-deployment-3066724191   1         1         0       6s
</span></code></pre>
</li>
<li>
<p>检查被创建的 Pods，可以看到一个新 ReplicaSet 创建的 Pod 停滞在拉取镜像的环节。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> get pods
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                                READY     STATUS             RESTARTS   AGE
</span><span>nginx-deployment-1564180365-70iae   1/1       Running            0          25s
</span><span>nginx-deployment-1564180365-jbqqo   1/1       Running            0          25s
</span><span>nginx-deployment-1564180365-hysrc   1/1       Running            0          25s
</span><span>nginx-deployment-3066724191-08mng   0/1       ImagePullBackOff   0          6s
</span></code></pre>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>Deployment 控制器会自动停止坏的上线过程，并停止扩展新的 ReplicaSet。这是依赖于用户可以指定的 rollingUpdate 参数（<code>maxUnavailable</code>）。k8s 默认设置该值为 25%。</p>

</blockquote>
</li>
<li>
<p>通过 <code>kubectl describe deployment</code> 获取 Deployment 详细信息，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Name:           nginx-deployment
</span><span>Namespace:      default
</span><span>CreationTimestamp:  Tue, 15 Mar 2016 14:48:04 -0700
</span><span>Labels:         app=nginx
</span><span>Selector:       app=nginx
</span><span>Replicas:       3 desired | 1 updated | 4 total | 3 available | 1 unavailable
</span><span>StrategyType:       RollingUpdate
</span><span>MinReadySeconds:    0
</span><span>RollingUpdateStrategy:  25% max unavailable, 25% max surge
</span><span>Pod Template:
</span><span>  Labels:  app=nginx
</span><span>  Containers:
</span><span>  nginx:
</span><span>    Image:        nginx:1.161
</span><span>    Port:         80/TCP
</span><span>    Host Port:    0/TCP
</span><span>    Environment:  &lt;none&gt;
</span><span>    Mounts:       &lt;none&gt;
</span><span>  Volumes:        &lt;none&gt;
</span><span>Conditions:
</span><span>  Type           Status  Reason
</span><span>  ----           ------  ------
</span><span>  Available      True    MinimumReplicasAvailable
</span><span>  Progressing    True    ReplicaSetUpdated
</span><span>OldReplicaSets:     nginx-deployment-1564180365 (3/3 replicas created)
</span><span>NewReplicaSet:      nginx-deployment-3066724191 (1/1 replicas created)
</span><span>Events:
</span><span>  FirstSeen LastSeen    Count   From                    SubObjectPath   Type        Reason              Message
</span><span>  --------- --------    -----   ----                    -------------   --------    ------              -------
</span><span>  1m        1m          1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-2035384211 to 3
</span><span>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 1
</span><span>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 2
</span><span>  22s       22s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 2
</span><span>  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 1
</span><span>  21s       21s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-1564180365 to 3
</span><span>  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled down replica set nginx-deployment-2035384211 to 0
</span><span>  13s       13s         1       {deployment-controller }                Normal      ScalingReplicaSet   Scaled up replica set nginx-deployment-3066724191 to 1
</span></code></pre>
<p>修复此状态，用户需要回滚到上一个稳定的 Deployment 修订版本。</p>
</li>
</ul>
<h4 id="jian-cha-deployment-shang-xian-li-shi">检查 Deployment 上线历史</h4>
<p>以下步骤检查回滚历史：</p>
<ol>
<li>
<p>首先检查改 Deployment 的修订版本：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout history deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployments &quot;nginx-deployment&quot;
</span><span>REVISION    CHANGE-CAUSE
</span><span>1           kubectl apply --filename=https://k8s.io/examples/controllers/nginx-deployment.yaml
</span><span>2           kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1
</span><span>3           kubectl set image deployment/nginx-deployment nginx=nginx:1.161
</span></code></pre>
<p><code>CHANGE-CAUSE</code> 的内容在修订版本被创建时，从 Deployment 的注解 <code>kubernetes.io/change-cause</code> 复制而来。用户可以通过下列方式设置 <code>CHANGE-CAUSE</code> 信息：</p>
<ul>
<li>使用 <code>kubectl annotate deployment/nginx-deployment kubernetes.io/change-cause=&quot;image updated to 1.16.1&quot;</code> 为 Deployment 添加注解。</li>
<li>手动编辑资源清单。</li>
</ul>
</li>
<li>
<p>查看每个修订历史的详细信息，运行：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout history deployment/nginx-deployment</span><span style="color:#bf616a;"> --revision</span><span>=2
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployments &quot;nginx-deployment&quot; revision 2
</span><span>  Labels:       app=nginx
</span><span>          pod-template-hash=1159050644
</span><span>  Annotations:  kubernetes.io/change-cause=kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1
</span><span>  Containers:
</span><span>  nginx:
</span><span>    Image:      nginx:1.16.1
</span><span>    Port:       80/TCP
</span><span>    QoS Tier:
</span><span>        cpu:      BestEffort
</span><span>        memory:   BestEffort
</span><span>    Environment Variables:      &lt;none&gt;
</span><span>  No volumes.
</span></code></pre>
</li>
</ol>
<h4 id="hui-gun-dao-zhi-qian-de-xiu-ding-ban-ben">回滚到之前的修订版本</h4>
<p>以下步骤回滚当前版本的 Deployment 到前一个版本，即版本 2。</p>
<ol>
<li>
<p>撤销当前上线，并回滚至上个版本：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout undo deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment rolled back
</span></code></pre>
<p>现在 Deployment 回滚到了上一个文档版本。可以看到，<code>DeploymentRollback</code> 回滚至版本 2 的事件是由 Deployment 控制器所生成的。</p>
</li>
<li>
<p>检查回滚是否成功，以及 Deployment 的运行是否达到预期，运行：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> get deployment nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment   3/3     3            3           30m
</span></code></pre>
</li>
<li>
<p>通过 <code>kubectl describe deployment nginx-deployment</code> 获取 Deployment 描述，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Name:                   nginx-deployment
</span><span>Namespace:              default
</span><span>CreationTimestamp:      Sun, 02 Sep 2018 18:17:55 -0500
</span><span>Labels:                 app=nginx
</span><span>Annotations:            deployment.kubernetes.io/revision=4
</span><span>                        kubernetes.io/change-cause=kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1
</span><span>Selector:               app=nginx
</span><span>Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
</span><span>StrategyType:           RollingUpdate
</span><span>MinReadySeconds:        0
</span><span>RollingUpdateStrategy:  25% max unavailable, 25% max surge
</span><span>Pod Template:
</span><span>  Labels:  app=nginx
</span><span>  Containers:
</span><span>  nginx:
</span><span>    Image:        nginx:1.16.1
</span><span>    Port:         80/TCP
</span><span>    Host Port:    0/TCP
</span><span>    Environment:  &lt;none&gt;
</span><span>    Mounts:       &lt;none&gt;
</span><span>  Volumes:        &lt;none&gt;
</span><span>Conditions:
</span><span>  Type           Status  Reason
</span><span>  ----           ------  ------
</span><span>  Available      True    MinimumReplicasAvailable
</span><span>  Progressing    True    NewReplicaSetAvailable
</span><span>OldReplicaSets:  &lt;none&gt;
</span><span>NewReplicaSet:   nginx-deployment-c4747d96c (3/3 replicas created)
</span><span>Events:
</span><span>  Type    Reason              Age   From                   Message
</span><span>  ----    ------              ----  ----                   -------
</span><span>  Normal  ScalingReplicaSet   12m   deployment-controller  Scaled up replica set nginx-deployment-75675f5897 to 3
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 1
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 2
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 2
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 1
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-c4747d96c to 3
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled down replica set nginx-deployment-75675f5897 to 0
</span><span>  Normal  ScalingReplicaSet   11m   deployment-controller  Scaled up replica set nginx-deployment-595696685f to 1
</span><span>  Normal  DeploymentRollback  15s   deployment-controller  Rolled back deployment &quot;nginx-deployment&quot; to revision 2
</span><span>  Normal  ScalingReplicaSet   15s   deployment-controller  Scaled down replica set nginx-deployment-595696685f to 0
</span></code></pre>
</li>
</ol>
<h3 id="ScalingADeployment">扩缩 Deployment</h3>
<p>可以通过以下命令扩展一个 Deployment：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> scale deployment/nginx-deployment</span><span style="color:#bf616a;"> --replicas</span><span>=10
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment scaled
</span></code></pre>
<p>假设用户的集群开启了水平 Pod 自动扩展，那么可以为 Deployment 设置自动缩放器 autoscaler，并根据现有 Pods 的 CPU 利用率，选择期望的最小和最大的 Pods 数量。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> autoscale deployment/nginx-deployment</span><span style="color:#bf616a;"> --min</span><span>=10</span><span style="color:#bf616a;"> --max</span><span>=15</span><span style="color:#bf616a;"> --cpu-percent</span><span>=80
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment scaled
</span></code></pre>
<h4 id="an-bi-li-suo-fang">按比例缩放</h4>
<p>滚动更新（RollingUpdate） Deployment 支持同一时间内运行若干版本的应用程序。当用户或者自动缩放器，在上线（无论是正在进行的还是暂停着的）的途中，缩放了一个滚动更新 Deployment，那么为了减轻风险， Deployment 控制器会平衡额外的副本在现有的运行状态的 ReplicaSets（带有 Pods 的 ReplicaSets）。</p>
<p>例如，用户正在运行一个拥有 10 个副本的 Deployment，maxSurge=3 以及 maxUnavailable=2。</p>
<ul>
<li>
<p>确保这 10 个副本正在运行：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> get deploy
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment     10        10        10           10          50s
</span></code></pre>
</li>
<li>
<p>更新 Deployment 使用新的镜像，刚好该镜像无法从集群内部解析。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> set image deployment/nginx-deployment nginx=nginx:sometag
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment image updated
</span></code></pre>
</li>
<li>
<p>镜像更新开始了一个带有 ReplicaSet <code>nginx-deployment-1989198191</code> 的新上线，但是因为上面设置的 <code>maxUnavailable</code> 参数阻塞了，通过 <code>kubectl get rs</code> 检查上线状态，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                          DESIRED   CURRENT   READY     AGE
</span><span>nginx-deployment-1989198191   5         5         0         9s
</span><span>nginx-deployment-618515232    8         8         8         1m
</span></code></pre>
</li>
<li>
<p>接着出现了新的 Deployment 缩放请求。自动缩放器将 Deployment 副本增加到 15。Deployment 控制器需要决定在哪里添加 5 个新的副本。如果使用的是按比例缩放，那么这 5 个副本将会被添加至新的 ReplicaSet。通过按比例缩放，可以将额外的副本分布到所有的 ReplicaSet。较大比例的副本会被添加到拥有最多副本的 ReplicaSet，而较低比例的副本会进入到副本较少的 ReplicaSet。所有剩下的副本都会添加到副本最多的 ReplicaSet。具有零副本的 ReplicaSet 不会被扩容。</p>
</li>
</ul>
<p>在上面的示例中，3 个副本被添加到旧 ReplicaSet 中，2 个副本被添加到新 ReplicaSet 中。假设新的副本健康，上线过程最终应该将所有副本迁移到新的 ReplicaSet 中。通过 <code>kubectl get deploy</code> 可以确认，并输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                 DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx-deployment     15        18        7            8           7m
</span></code></pre>
<p>上线状态确认了副本是如何被添加到每个 ReplicaSet 的。通过 <code>kubectl get rs</code> 输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME                          DESIRED   CURRENT   READY     AGE
</span><span>nginx-deployment-1989198191   7         7         0         7m
</span><span>nginx-deployment-618515232    11        11        11        7m
</span></code></pre>
<h3 id="PausingAndResumingADeployment">暂停和恢复上线</h3>
<p>更新一个 Deployment 时，或者是计划更新时，用户可以在触发一个或多个更新前暂停上线。当准备好应用这些更新时，用户可以为 Deployment 恢复上线。这个方法允许用户在暂停和恢复期间，应用若干修复而不触发没有必要的上线过程。</p>
<ul>
<li>
<p>例如，一个已经创建了的 Deployment，通过 <code>kubectl get deploy</code> 获取其明细，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span><span>nginx     3         3         3            3           1m
</span></code></pre>
<p>通过 <code>kubectl get rs</code>，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               DESIRED   CURRENT   READY     AGE
</span><span>nginx-2142116321   3         3         3         1m
</span></code></pre>
</li>
<li>
<p>通过 <code>kubectl rollout pause deployment/nginx-deployment</code> 命令暂停上线，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment paused
</span></code></pre>
</li>
<li>
<p>接着 <code>kubectl set image deployment/nginx-deployment nginx=nginx:1.16.1</code> 更新 Deployment 的镜像，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment image updated
</span></code></pre>
</li>
<li>
<p>注意没有新的上线过程开始，通过 <code>kubectl rollout history deployment/nginx-deployment</code> 检查，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployments &quot;nginx&quot;
</span><span>REVISION  CHANGE-CAUSE
</span><span>1   &lt;none&gt;
</span></code></pre>
</li>
<li>
<p>获取上线状态确认现存的 ReplicaSet 没有变化，通过 <code>kubectl get rs</code> 检查，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               DESIRED   CURRENT   READY     AGE
</span><span>nginx-2142116321   3         3         3         2m
</span></code></pre>
</li>
<li>
<p>用户可以根据需要执行很多更新操作，例如通过 <code>kubectl set resources deployment/nginx-deployment -c=nginx --limits=cpu=200m,memory=512Mi</code> 更新所需的资源，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment resource requirements updated
</span></code></pre>
<p>暂停 Deployment 上线之前的初始状态将继续发挥作用，但新的更新在 Deployment 上线被暂停期间不会产生任何效果。</p>
</li>
<li>
<p>最终，通过 <code>kubectl rollout resume deployment/nginx-deployment</code>，恢复 Deployment 上线，并观察新的 ReplicaSet 创建的过程，其中包含了所有应用的所有更新，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment resumed
</span></code></pre>
</li>
<li>
<p>通过 <code>kubectl get rs -w</code> 观察上线状态，直到其完成，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               DESIRED   CURRENT   READY     AGE
</span><span>nginx-2142116321   2         2         2         2m
</span><span>nginx-3926361531   2         2         0         6s
</span><span>nginx-3926361531   2         2         1         18s
</span><span>nginx-2142116321   1         2         2         2m
</span><span>nginx-2142116321   1         2         2         2m
</span><span>nginx-3926361531   3         2         1         18s
</span><span>nginx-3926361531   3         2         1         18s
</span><span>nginx-2142116321   1         1         1         2m
</span><span>nginx-3926361531   3         3         1         18s
</span><span>nginx-3926361531   3         3         2         19s
</span><span>nginx-2142116321   0         1         1         2m
</span><span>nginx-2142116321   0         1         1         2m
</span><span>nginx-2142116321   0         0         0         2m
</span><span>nginx-3926361531   3         3         3         20s
</span></code></pre>
</li>
<li>
<p>通过 <code>kubectl get rs</code> 获取最新的上线状态，输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>NAME               DESIRED   CURRENT   READY     AGE
</span><span>nginx-2142116321   0         0         0         2m
</span><span>nginx-3926361531   3         3         3         28s
</span></code></pre>
</li>
</ul>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>不可以回滚处于暂停状态的 Deployment 除非先恢复它。</p>

</blockquote>
<h3 id="DeploymentStatus">Deployment 状态</h3>
<p>Deployment 在其存续期间，会进入不同的状态。可以是在上线新的 ReplicaSet 时的进行中（progressing），可以是完成（complete），或者是失败（failed）。</p>
<h4 id="jin-xing-zhong-de-deployment">进行中的 Deployment</h4>
<p>当以下任务被执行时，k8s 会标记 Deployment 为<em>进行中 progressing</em>：</p>
<ul>
<li>Deployment 创建一个新的 ReplicaSet。</li>
<li>Deployment 扩容新的 ReplicaSet。</li>
<li>Deployment 缩容旧的 ReplicaSet(s)。</li>
<li>新的 Pods 准备就绪或是可用了（就绪至少持续了 MinReadySeconds 秒）。</li>
</ul>
<p>当上线状态变为“进行中”，Deployment 控制器添加包含下列属性的条件至 Deployment 的 <code>.status.conditions</code>：</p>
<ul>
<li><code>type: Progressing</code></li>
<li><code>status: &quot;True&quot;</code></li>
<li><code>reason: NewReplicaSetCreated</code> | <code>reason: FoundNewReplicaSet</code> | <code>reason: ReplicaSetUpdated</code></li>
</ul>
<p>用户可以使用 <code>kubectl rollout status</code> 监控 Deployment 的进度。</p>
<h4 id="wan-cheng-de-deployment">完成的 Deployment</h4>
<p>当以下特征出现时，k8s 会标记 Deployment 为<em>完成 complete</em>：</p>
<ul>
<li>所有与 Deployment 相关的副本都被更新到了最新的版本，意味着任何用户请求的更新都完成了。</li>
<li>所有与 Deployment 相关的副本都可用了。</li>
<li>Deployment 的旧副本不再运行。</li>
</ul>
<p>当上新状态变为“完成”，Deployment 控制器添加包含下列属性的条件至 Deployment 的 <code>.status.conditions</code>：</p>
<ul>
<li><code>type: Progressing</code></li>
<li><code>status: &quot;True&quot;</code></li>
<li><code>reason: NewReplicaSetAvailable</code></li>
</ul>
<p><code>Progressing</code> 状况会持续为 <code>&quot;True&quot;</code>，直到新的上线被触发。即使副本的可用状态发生变化（进而影响 <code>Available</code> 状况），<code>Progressing</code> 状况的值也不会变化。</p>
<p>可以通过 <code>kubectl rollout status</code> 检查一个 Deployment 是否完成。如果上线成功完成，<code>kubectl rollout status</code> 返回退出代码 0。</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> rollout status deployment/nginx-deployment
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>Waiting for rollout to finish: 2 of 3 updated replicas are available...
</span><span>deployment &quot;nginx-deployment&quot; successfully rolled out
</span></code></pre>
<h4 id="shi-bai-de-deployment">失败的 Deployment</h4>
<p>Deployment 在部署最新的 ReplicaSet 时，会遇到阻塞并一直处于未完成的状态。这可能有以下几个因素造成：</p>
<ul>
<li>配额（quota）不足</li>
<li>就绪探测（readiness probe）失败</li>
<li>镜像拉取错误</li>
<li>权限不足</li>
<li>限制范围（limit ranges）</li>
<li>应用程序运行时的配置错误</li>
</ul>
<p>检测此状况的方法之一是在 Deployment 规约中指定截止时间参数：（<code>.spec.progressDeadlineSeconds</code>）。<code>.spec.progressDeadlineSeconds</code> 给出的是一个秒数值，Deployment 控制器在（通过 Deployment 状态）标识 Deployment 进展停滞之前，需要等待所给的时长。</p>
<p>以下 <code>kubectl</code> 命令设置规约中的 <code>progressDeadlineSeconds</code> 使得控制器在 10 分钟后报告 Deployment 没有进展：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">kubectl</span><span> patch deployment/nginx-deployment</span><span style="color:#bf616a;"> -p </span><span>&#39;</span><span style="color:#a3be8c;">{&quot;spec&quot;:{&quot;progressDeadlineSeconds&quot;:600}}</span><span>&#39;
</span></code></pre>
<p>输出类似于：</p>
<pre data-lang="txt" style="background-color:#2b303b;color:#c0c5ce;" class="language-txt "><code class="language-txt" data-lang="txt"><span>deployment.apps/nginx-deployment patched
</span></code></pre>
<p>一旦超过了截止时间，Deployment 控制器会添加包含下列属性的状况到 Deployment 的 <code>.status.conditions</code> 中：</p>
<ul>
<li><code>type: Progressing</code></li>
<li><code>status: &quot;False&quot;</code></li>
<li><code>reason: ProgressDeadlineExceeded</code></li>
</ul>
<p>这个状况也可能会在较早的时候失败，因而其状态被设为 <code>&quot;False&quot;</code>，这是因为 <code>ReplicaSetCreateError</code>。一旦 Deployment 上线完成，就不再考虑截止时间。</p>
<h4 id="dui-shi-bai-deployment-de-cao-zuo">对失败 Deployment 的操作</h4>
<p>所有用在已完成的 Deployment 的操作也适用于失败的 Deployment 上。用户可以对其阔缩容，回滚至前一个修订版本，或是需要对 Deployment 的 Pod 模板应用多项调整时将 Deployment 暂停。</p>
<h3 id="CleanUpPolicy">清理策略</h3>
<p>可以在 Deployment 中设置 <code>.spec.revisionHistoryLimit</code> 字段来指定保留该 Deployment 的旧 ReplicaSet。其余的 ReplicaSet 将在后台被垃圾回收。默认情况下，该值为 10。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>显式将此字段设置为 0 将导致 Deployment 的所有历史记录被清空，因此 Deployment 将无法回滚。</p>

</blockquote>
<h3 id="jin-si-que-bu-shu">金丝雀部署</h3>
<p>如果要是用 Deployment 向用户子集或服务器子集上线版本，可以遵守资源管理所描述的金丝雀模式，为每个版本创建一个 Deployment。</p>
<h3 id="bian-xie-deployment-gui-yue">编写 Deployment 规约</h3>
<p>与其它 k8s 配置一样，Deployment 需要 <code>.apiVersion</code>，<code>.kind</code> 以及 <code>.metadata</code> 字段。</p>
<p>Deployment 对象的名称必须是合法的 DNS 子域名。Deployment 还需要 <code>.spec</code> 部分。</p>
<h4 id="DeploymentsPodTemplate">Pod 模板</h4>
<p><code>.spec</code> 仅需要两个字段 <code>.spec.template</code> 与 <code>.spec.selector</code>。</p>
<p><code>.spec.template</code> 是一个 Pod 模板。它拥有与 Pod 完全相同的规则，因为是嵌套的，所以不需要 <code>apiVersion</code> 或 <code>kind</code>。</p>
<p>除了 Pod 需要的字段，Deployment 的 Pod 模板必须指定合适的标签以及合适的重启策略。对于标签而言，确保不要与其它控制器重叠。</p>
<p>只有 <code>.spec.template.spec.restartPolicy</code> 等于 <code>Always</code> 是允许的，这也是没有指定情况下的默认值。</p>
<h4 id="fu-ben">副本</h4>
<p><code>.spec.replicas</code> 是一个可选字段，用于指定期望 Pods 的数量。其默认值为 1。</p>
<p>如果你对某个 Deployment 执行了手动扩缩操作（例如通过 <code>kubectl scale deployment deployment --replicas=X</code>），之后根据清单对 Deployment 执行了更新操作（例如通过运行 <code>kubectl apply -f deployment.yaml</code>），那么通过应用清单完成的更新会覆盖之前手动扩缩的变更。</p>
<p>如果一个 HorizontalPodAutoscaler（或者其他执行水平扩缩操作的类似 API）在管理 Deployment 的扩缩，则不要设置 <code>.spec.replicas</code>。</p>
<p>相反的，应该允许 k8s 控制面来自动管理 <code>.spec.replicas</code> 字段。</p>
<h4 id="xuan-ze-fu">选择符</h4>
<p><code>.spec.selector</code> 是一个必须字段，用于指定该 Deployment 目标 Pods 的标签选择符。</p>
<p><code>.spec.selector</code> 必须匹配 <code>.spec.template.metadata.labels</code>，否则它会被 API 拒绝。</p>
<p>API 版本 <code>apps/v1</code>，<code>.spec.selector</code> 以及 <code>.metadata.labels</code> 不会默认设置为 <code>.spec.template.metadata.labels</code>，所以需要明确的进行设置。同时注意 <code>.spec.selector</code> 在 Deployment 创建 <code>apps/v1</code> 后是不可变的。</p>
<p>Deployment 可能会终结匹配到标签 selector 的 Pods，如果它们的模板不同于 <code>.spec.template</code> 或者该 Pods 总数超出 <code>.spec.replicas</code>。它也会创建带有 <code>.spec.template</code> 的新 Pods，如果 Pods 的总数小于期望值。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>用户不该直接创建与此选择符匹配的 Pods，无论是直接通过另一个 Deployment，或者是另一个控制器例如 ReplicaSet 或者一个 ReplicationController。如果用户这么做了，第一个 Deployment 会认为它创建了这些 Pod。k8s 不会阻止该行为。</p>

</blockquote>
<p>如果有多个控制器的选择符发生重叠，则控制器之间会因为冲突而无法正常工作。</p>
<h4 id="ce-lue">策略</h4>
<p><code>.spec.strategy</code> 用于指定更新旧 Pod 的策略。<code>.spec.strategy.type</code> 可以是“重新创建”或者是“滚动更新”，后者是默认值。</p>
<h5 id="zhong-jian-deployment">重建 Deployment</h5>
<p>当 <code>.spec.strategy.type==Recreate</code> 时，所有现存的 Pods 会在新的 Pods 创建之前被杀死。</p>
<blockquote class="blockquote-note">
	<p class="font-bold">说明：</p>
	<p>这只会确保为了升级而创建新 Pod 之前其他 Pod 都已经终止。如果升级一个 Deployment，所有旧版本的 Pod 都会被立刻终止。控制器等待这些 Pod 被成功移除之后才会创建新版本的 Pod。如果手动删除一个 Pod，其生命周期是由 ReplicaSet 控制的，后者会立刻创建一个替换 Pod（即使旧的 Pod 仍然处于 Terminating 状态）。如果用户需要一种“最多 n 个”的 Pod 个数保证，则需要使用 StatefulSet。</p>

</blockquote>
<h5 id="gun-dong-geng-xin-deployment">滚动更新 Deployment</h5>
<p>当 <code>.spec.strategy.type==RollingUpdate</code> 时，Deployment 更新 Pods 会以滚动方式更新。用户可以指定 <code>maxUnavailable</code> 和 <code>maxSurge</code> 来控制滚动更新过程。</p>
<h6 id="zui-da-bu-ke-yong">最大不可用</h6>
<p><code>.spec.strategy.rollingUpdate.maxUnavailable</code> 是一个可选字段，用于指定在更新过程中，最大不可用 Pods 的数量。该值可以是绝对数值（例如 5）或者是期望 Pods 的百分比（例如 10%）。百分比值会转换成绝对数并去除小数部分。如果 <code>.spec.strategy.rollingUpdate.maxSurge</code> 为 0，则最大不可用不能为 0。最大不可用默认值为 25%。</p>
<h6 id="zui-da-feng-zhi">最大峰值</h6>
<p><code>.spec.strategy.rollingUpdate.maxSurge</code> 是一个可选字段，用于指定可以创建的超出期望 Pod 的数量。该值可以是绝对数值（例如 5）或者是期望 Pods 的百分比（例如 10%）。如果 <code>.spec.strategy.rollingUpdate.maxUnavailable</code> 为 0，则最大峰值不可为 0。百分比值会通过向上取整转换为绝对数值。最大峰值默认值为 25%。</p>
<h4 id="jin-du-qi-xian-miao-shu">进度期限秒数</h4>
<p><code>.spec.progressDeadlineSeconds</code> 是一个可选字段，用于指定期望 Deployment 在进展失败之前，等待其取得进展的秒数。该报告会在资源状态中体现为 <code>type: Progressing</code>，<code>status: False</code>，<code>reason: ProgressDeadlineExceeded</code>。Deployment 控制器将持续重试 Deployment。之后只要实现了自动回滚，Deployment 控制器将在探测到这样的条件时立刻回滚 Deployment。</p>
<p>如果指定，该值需要大于 <code>.spec.minReadySeconds</code> 的值。</p>
<h4 id="zui-duan-jiu-xu-shi-jian">最短就绪时间</h4>
<p><code>.spec.minReadySeconds</code> 是一个可选字段，用于指定新创建的 Pod 在没有任何容器崩溃的情况下最短的就绪时间，只有超出这个时间 Pod 才会被视为可用。该值默认值为 0（即 Pod 在准备就绪后立刻被视为可用）。了解何时 Pod 被视为就绪，请参考容器探针。</p>
<h4 id="xiu-ding-li-shi-xian-zhi">修订历史限制</h4>
<p>Deployment 的修订历史记录存储在它所控制的 ReplicaSet 中。</p>
<p><code>.spec.revisionHistoryLimit</code> 是一个可选字段，用于指定回滚时所需要保留的旧 ReplicaSet 数量。这些旧 ReplicaSet 会消耗 etcd 中的资源，并占用 <code>kubectl get rs</code> 的输出。每个 Deployment 修订版本的配置都存储在其 ReplicaSets 中；一旦删除了旧 ReplicaSet，将失去回滚到 Deployment 的对应修订版本的能力。默认系统保留 10 个旧 ReplicaSet，但是其理想值取决于新 Deployment 的频率和稳定性。</p>
<p>更具体的说，此字段设置为 0 意味着将清理所有具有 0 个副本的旧 ReplicaSet。这种情况下，无法撤销新的 Deployment 上线，因为它的修订历史被清除了。</p>
<h4 id="zan-ting-de-paused">暂停的（Paused）</h4>
<p><code>.spec.paused</code> 用于暂停和恢复 Deployment 的可选布尔字段。暂停的 Deployment 和未暂停的 Deployment 的唯一区别在于 Deployment 处于暂停状态时，PodTemplateSpec 的任何修改都不会触发新的上线。Deployment 在创建时是默认不会处于暂停状态。</p>
<h2 id="replicaset">ReplicaSet</h2>
<p>ReplicaSet 的目的在于维护组在任何时候都处于运行状态的 Pods 副本的稳定集合。因此它通常用于保障给定数量的且完全相同的 Pods 可用性。</p>
<h3 id="replicaset-gong-zuo-yuan-li">ReplicaSet 工作原理</h3>
<p>ReplicaSet 定义了一些字段，包含用于指定如何获取 Pod 的选择符，需要维护的副本数量，用于指定应该创建多少新 Pods 来达成副本条件的 pod 模板等。ReplicaSet 根据需要创建和删除 Pod 使得副本个数达到期望值，进而体现其存在价值。当 ReplicaSet 需要创建新的 Pod 时，会使用所提供的 Pod 模板。</p>
<p>ReplicaSet 通过 Pods 的 metadata.ownerReferences 字段来连接其 Pods，该字段指定了当前对象被何种资源所拥有。ReplicaSet 所获得的所有 Pods 都在其 ownerReferences 字段中包含了属主 ReplicaSet 的标识信息。通过这个连接 ReplicaSet 才能正确的知道其维护与计划的 Pods 的状态。</p>
<p>ReplicaSet 通过使用其选择符来识别要获取的新 Pods。如果一个 Pod 没有 OwnerReference 或者 OwnerReference 不是一个控制器并且匹配到一个 ReplicaSet 选择符，则该 Pod 立刻被此 ReplicaSet 获得。</p>
<h3 id="he-shi-shi-yong-replicaset">何时使用 ReplicaSet</h3>
<p>ReplicaSet 确保规定数量的 pod 副本可以在任何时候都处于运行状态。然而，Deployment 是更高阶的概念，其用作于管理 ReplicaSets 并为 Pods 提供声明式的更新，以及其它有用的功能。因此，我们建议使用 Deployments 而不是直接使用 ReplicaSets，除非用户需要自定义更新业务流程或根本不需要更新。</p>
<p>这就意味着，用户可能永远不需要操作 ReplicaSet 对象：而是使用 Deployment，并在 spec 部分定义应用。</p>
<h3 id="ReplicaSetExample">示例</h3>
<p>WIP</p>
<h3 id="fei-mo-ban-pod-huo-qu">非模板 Pod 获取</h3>
<p>WIP</p>
<h3 id="bian-xie-replicaset-qing-dan">编写 ReplicaSet 清单</h3>
<p>WIP</p>
<h4 id="pod-mo-ban-bian-xie">Pod 模板编写</h4>
<p>WIP</p>
<h4 id="ReplicaSetPodSelector">Pod 选择符</h4>
<p>WIP</p>
<h4 id="replicas">Replicas</h4>
<p>WIP</p>
<h3 id="shi-yong-replicaset">使用 ReplicaSet</h3>
<p>WIP</p>
<h4 id="shan-chu-replicaset-yu-qi-pods">删除 ReplicaSet 与其 Pods</h4>
<p>WIP</p>
<h4 id="jin-shan-chu-replicaset">仅删除 ReplicaSet</h4>
<p>WIP</p>
<h4 id="jiang-pod-cong-replicaset-zhong-ge-chi">将 Pod 从 ReplicaSet 中隔离</h4>
<p>WIP</p>
<h4 id="kuo-suo-replicaset">扩缩 ReplicaSet</h4>
<p>WIP</p>
<h4 id="pod-shan-chu-kai-xiao">Pod 删除开销</h4>
<p>WIP</p>
<h4 id="replicaset-zuo-wei-shui-ping-de-pod-zi-dong-kuo-suo-qi-mu-biao">ReplicaSet 作为水平的 Pod 自动扩缩器目标</h4>
<p>WIP</p>
<h3 id="replicaset-ti-dai-fang-an">ReplicaSet 替代方案</h3>
<p>WIP</p>
<h4 id="deployment-tui-jian">Deployment（推荐）</h4>
<p>WIP</p>
<h4 id="AlternativesToReplicaSetBarePods">裸 Pod</h4>
<p>WIP</p>
<h4 id="AlternativesToReplicaSetJob">Job</h4>
<p>WIP</p>
<h4 id="AlternativesToReplicaSetDaemonSet">DaemonSet</h4>
<p>WIP</p>
<h4 id="AlternativesToReplicaSetReplicationController">ReplicationController</h4>
<p>WIP</p>
<h2 id="statefulsets">StatefulSets</h2>
<p>StatefulSet 用于管理带有状态的应用程序的工作负载 API 对象。</p>
<p>管理 Pods 集合的部署和扩缩，并且为这些 Pods 提供<em>排序与唯一性的保障</em>。</p>
<p>与 Deployment 类似，StatefulSet 根据相同容器规约管理 Pods。与 Deployment 不同的是，StatefulSet 为每个 Pod 维护了一个有粘性的 ID。这些 Pod 是基于相同的规约来创建的，但是不能互相替换；无论如何调度，每个 Pod 都有一个永久不变的 ID。</p>
<p>如果用户希望使用存储卷为工作负载提供持久储存，可以使用 StatefulSet 作为解决方案的一部分。尽管 StatefulSet 中的单个 Pod 仍然可能出现故障，但持久的 Pod 标识符使得将现有卷与替换已失败 Pod 的新 Pod 相匹配变得更加容易。</p>
<h3 id="shi-yong-statefulset">使用 StatefulSet</h3>
<p>StatefulSet 对于需要满足以下一个或多个需求的应用程序很有价值：</p>
<ul>
<li>稳定的，唯一的网络标识符。</li>
<li>稳定的，持久的存储。</li>
<li>有序的，优雅的部署和扩缩。</li>
<li>有序的，自动的滚动更新。</li>
</ul>
<p>上述需求中，稳定意味着 Pod （重新）调度的整个过程带有持久性质的。如果应用程序不需要任何稳定的标识符或有序的部署，删除或扩缩，则应该使用一组无状态的副本控制器提供的工作负载来部署应用程序，比如 Deployment 或者 ReplicaSet 可能更适合无状态应用部署的需要。</p>
<h3 id="xian-zhi">限制</h3>
<p>WIP</p>
<h3 id="zu-jian">组件</h3>
<p>WIP</p>
<h4 id="StatefulSetPodSelector">Pod 选择符</h4>
<p>WIP</p>
<h4 id="juan-sheng-ming-mo-ban">卷声明模板</h4>
<p>WIP</p>
<h4 id="zui-duan-jiu-xu-miao-shu">最短就绪秒数</h4>
<p>WIP</p>
<h3 id="pod-biao-shi">Pod 标识</h3>
<p>WIP</p>
<h4 id="you-xu-suo-yin">有序索引</h4>
<p>WIP</p>
<h4 id="wen-ding-de-wang-luo-id">稳定的网络 ID</h4>
<p>WIP</p>
<h4 id="wen-ding-de-cun-chu">稳定的存储</h4>
<p>WIP</p>
<h4 id="pod-ming-cheng-biao-qian">Pod 名称标签</h4>
<p>WIP</p>
<h3 id="bu-shu-yu-kuo-suo-bao-zheng">部署与扩缩保证</h3>
<p>WIP</p>
<h4 id="pod-guan-li-ce-lue">Pod 管理策略</h4>
<p>WIP</p>
<h3 id="geng-xin-ce-lue">更新策略</h3>
<p>WIP</p>
<h3 id="gun-dong-geng-xin">滚动更新</h3>
<p>WIP</p>
<h4 id="fen-qu-gun-dong-geng-xin">分区滚动更新</h4>
<p>WIP</p>
<h4 id="zui-da-bu-ke-yong-pod">最大不可用 Pod</h4>
<p>WIP</p>
<h4 id="qiang-zhi-hui-gun">强制回滚</h4>
<p>WIP</p>
<h3 id="persistentvolumeclaim-bao-liu">PersistentVolumeClaim 保留</h3>
<p>WIP</p>
<h4 id="fu-ben-shu">副本数</h4>
<p>WIP</p>
<h2 id="daemonset">DaemonSet</h2>
<p>DaemonSet 确保所有（或者部分）节点运行拷贝的 Pod。当节点被添加到集群时，Pods 也同样的被添加。当节点从集群中移除时，这些 Pods 则被垃圾回收。删除 DaemonSet 将会清理其创建的 Pods。</p>
<p>DaemonSet 的一些典型的用例：</p>
<ul>
<li>在每个节点上运行集群守护进程</li>
<li>在每个节点上运行日志收集守护进程</li>
<li>在每个节点上运行监控守护进程</li>
</ul>
<p>一种简单的用法是为每种类型的守护进程在所有节点上都启动一个 DaemonSet。一个稍微复杂的用法是为同一种守护进程部署多个 DaemonSet；每个具有不同的标志，并且对不同硬件类型具有不同的内存，CPU 要求。</p>
<h3 id="bian-xie-daemonset-spec">编写 DaemonSet Spec</h3>
<p>WIP</p>
<h4 id="chuang-jian-daemonset">创建 DaemonSet</h4>
<p>WIP</p>
<h4 id="bi-xu-zi-duan">必须字段</h4>
<p>WIP</p>
<h4 id="DaemonSetPodTemplate">Pod 模板</h4>
<p>WIP</p>
<h4 id="pod-xuan-ze-fu">Pod 选择符</h4>
<p>WIP</p>
<h4 id="jin-zai-mou-xie-jie-dian-shang-yun-xing-pod">仅在某些节点上运行 Pod</h4>
<p>WIP</p>
<h3 id="daemon-pods-ru-he-bei-diao-du">Daemon Pods 如何被调度</h3>
<p>WIP</p>
<h4 id="tong-guo-mo-ren-diao-du-qi-diao-du">通过默认调度器调度</h4>
<p>WIP</p>
<h4 id="wu-dian-he-rong-ren-du">污点和容忍度</h4>
<p>WIP</p>
<h3 id="yu-daemonset-tong-xin">与 DaemonSet 通信</h3>
<p>WIP</p>
<h3 id="geng-xin-daemonset">更新 DaemonSet</h3>
<p>WIP</p>
<h3 id="daemonset-ti-dai-fang-an">DaemonSet 替代方案</h3>
<p>WIP</p>
<h4 id="DaemonSetInitScripts">init 脚本</h4>
<p>WIP</p>
<h4 id="DaemonSetBarePods">裸 Pod</h4>
<p>WIP</p>
<h4 id="DaemonSetStaticPods">静态 Pod</h4>
<p>WIP</p>
<h4 id="DaemonSetDeployment">Deployments</h4>
<p>WIP</p>
<h2 id="jobs">Jobs</h2>
<p>WIP</p>
<h3 id="yun-xing-shi-li-job">运行示例 Job</h3>
<p>WIP</p>
<h3 id="bian-xie-job-gui-yue">编写 Job 规约</h3>
<p>WIP</p>
<h4 id="JobsPodTemplate">Pod 模板</h4>
<p>WIP</p>
<h4 id="JobsPodSelector">Pod 选择符</h4>
<p>WIP</p>
<h4 id="job-bing-xing-zhi-xing">Job 并行执行</h4>
<p>WIP</p>
<h4 id="wan-cheng-mo-shi">完成模式</h4>
<p>WIP</p>
<h3 id="chu-li-pod-he-rong-qi-shi-xiao">处理 Pod 和容器失效</h3>
<p>WIP</p>
<h4 id="pod-hui-tui-shi-xiao-ce-lue">Pod 回退失效策略</h4>
<p>WIP</p>
<h3 id="job-zhong-zhi-yu-qing-li">Job 终止与清理</h3>
<p>WIP</p>
<h3 id="zi-dong-qing-li-wan-cheng-de-job">自动清理完成的 Job</h3>
<p>WIP</p>
<h4 id="yi-wan-cheng-job-de-ttl-ji-zhi">已完成 Job 的 TTL 机制</h4>
<p>WIP</p>
<h3 id="job-mo-shi">Job 模式</h3>
<p>WIP</p>
<h3 id="gao-ji-yong-fa">高级用法</h3>
<p>WIP</p>
<h4 id="gua-qi-job">挂起 Job</h4>
<p>WIP</p>
<h4 id="ke-bian-diao-du-zhi-ling">可变调度指令</h4>
<p>WIP</p>
<h4 id="zhi-ding-pod-xuan-ze-fu">指定 Pod 选择符</h4>
<p>WIP</p>
<h4 id="shi-yong-finalizer-zhui-zong-job">使用 Finalizer 追踪 Job</h4>
<p>WIP</p>
<h3 id="JobsAlternatives">替代方案</h3>
<p>WIP</p>
<h4 id="JobsBarePod">裸 Pod</h4>
<p>WIP</p>
<h4 id="fu-ben-kong-zhi-qi">副本控制器</h4>
<p>WIP</p>
<h4 id="dan-ge-job-qi-dong-kong-zhi-qi-pod">单个 Job 启动控制器 Pod</h4>
<p>WIP</p>
<h2 id="yi-wan-cheng-jobs-de-zi-dong-qing-li">已完成 Jobs 的自动清理</h2>
<p>WIP</p>
<h2 id="cronjob">CronJob</h2>
<p>WIP</p>
<h2 id="replicationcontroller">ReplicationController</h2>
<p>WIP</p>
</div>
					
<script
	src="https://utteranc.es/client.js"
	repo="jacobbishopxy/jacobbishopxy.github.io"
	issue-term="title"
	label="comments"
	theme="github-light"
	crossorigin="anonymous"
	async
></script>

				</article>
			</div>
			
			<div class="column is-2 is-hidden-mobile">
				<aside class="menu" style="position: sticky; top: 48px">
					<p class="heading has-text-weight-bold">Contents</p>
					<ul class="menu-list">
						
						<li>
							<a
								id="link-deployments"
								class="toc is-size-7 is-active"
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#deployments"
							>
								Deployments
							</a>
							
							<ul>
								
								<li>
									<a
										id="link-shi-yong-an-li"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#shi-yong-an-li"
									>
										使用案例
									</a>
								</li>
								
								<li>
									<a
										id="link-UpdatingADeployment"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#UpdatingADeployment"
									>
										更新 Deployment
									</a>
								</li>
								
								<li>
									<a
										id="link-RollingBackADeployment"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#RollingBackADeployment"
									>
										回滚 Deployment
									</a>
								</li>
								
								<li>
									<a
										id="link-ScalingADeployment"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#ScalingADeployment"
									>
										扩缩 Deployment
									</a>
								</li>
								
								<li>
									<a
										id="link-PausingAndResumingADeployment"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#PausingAndResumingADeployment"
									>
										暂停和恢复上线
									</a>
								</li>
								
								<li>
									<a
										id="link-DeploymentStatus"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#DeploymentStatus"
									>
										Deployment 状态
									</a>
								</li>
								
								<li>
									<a
										id="link-CleanUpPolicy"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#CleanUpPolicy"
									>
										清理策略
									</a>
								</li>
								
								<li>
									<a
										id="link-jin-si-que-bu-shu"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#jin-si-que-bu-shu"
									>
										金丝雀部署
									</a>
								</li>
								
								<li>
									<a
										id="link-bian-xie-deployment-gui-yue"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#bian-xie-deployment-gui-yue"
									>
										编写 Deployment 规约
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li>
							<a
								id="link-replicaset"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#replicaset"
							>
								ReplicaSet
							</a>
							
							<ul>
								
								<li>
									<a
										id="link-replicaset-gong-zuo-yuan-li"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#replicaset-gong-zuo-yuan-li"
									>
										ReplicaSet 工作原理
									</a>
								</li>
								
								<li>
									<a
										id="link-he-shi-shi-yong-replicaset"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#he-shi-shi-yong-replicaset"
									>
										何时使用 ReplicaSet
									</a>
								</li>
								
								<li>
									<a
										id="link-ReplicaSetExample"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#ReplicaSetExample"
									>
										示例
									</a>
								</li>
								
								<li>
									<a
										id="link-fei-mo-ban-pod-huo-qu"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#fei-mo-ban-pod-huo-qu"
									>
										非模板 Pod 获取
									</a>
								</li>
								
								<li>
									<a
										id="link-bian-xie-replicaset-qing-dan"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#bian-xie-replicaset-qing-dan"
									>
										编写 ReplicaSet 清单
									</a>
								</li>
								
								<li>
									<a
										id="link-shi-yong-replicaset"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#shi-yong-replicaset"
									>
										使用 ReplicaSet
									</a>
								</li>
								
								<li>
									<a
										id="link-replicaset-ti-dai-fang-an"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#replicaset-ti-dai-fang-an"
									>
										ReplicaSet 替代方案
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li>
							<a
								id="link-statefulsets"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#statefulsets"
							>
								StatefulSets
							</a>
							
							<ul>
								
								<li>
									<a
										id="link-shi-yong-statefulset"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#shi-yong-statefulset"
									>
										使用 StatefulSet
									</a>
								</li>
								
								<li>
									<a
										id="link-xian-zhi"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#xian-zhi"
									>
										限制
									</a>
								</li>
								
								<li>
									<a
										id="link-zu-jian"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#zu-jian"
									>
										组件
									</a>
								</li>
								
								<li>
									<a
										id="link-pod-biao-shi"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#pod-biao-shi"
									>
										Pod 标识
									</a>
								</li>
								
								<li>
									<a
										id="link-bu-shu-yu-kuo-suo-bao-zheng"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#bu-shu-yu-kuo-suo-bao-zheng"
									>
										部署与扩缩保证
									</a>
								</li>
								
								<li>
									<a
										id="link-geng-xin-ce-lue"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#geng-xin-ce-lue"
									>
										更新策略
									</a>
								</li>
								
								<li>
									<a
										id="link-gun-dong-geng-xin"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#gun-dong-geng-xin"
									>
										滚动更新
									</a>
								</li>
								
								<li>
									<a
										id="link-persistentvolumeclaim-bao-liu"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#persistentvolumeclaim-bao-liu"
									>
										PersistentVolumeClaim 保留
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li>
							<a
								id="link-daemonset"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#daemonset"
							>
								DaemonSet
							</a>
							
							<ul>
								
								<li>
									<a
										id="link-bian-xie-daemonset-spec"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#bian-xie-daemonset-spec"
									>
										编写 DaemonSet Spec
									</a>
								</li>
								
								<li>
									<a
										id="link-daemon-pods-ru-he-bei-diao-du"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#daemon-pods-ru-he-bei-diao-du"
									>
										Daemon Pods 如何被调度
									</a>
								</li>
								
								<li>
									<a
										id="link-yu-daemonset-tong-xin"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#yu-daemonset-tong-xin"
									>
										与 DaemonSet 通信
									</a>
								</li>
								
								<li>
									<a
										id="link-geng-xin-daemonset"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#geng-xin-daemonset"
									>
										更新 DaemonSet
									</a>
								</li>
								
								<li>
									<a
										id="link-daemonset-ti-dai-fang-an"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#daemonset-ti-dai-fang-an"
									>
										DaemonSet 替代方案
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li>
							<a
								id="link-jobs"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#jobs"
							>
								Jobs
							</a>
							
							<ul>
								
								<li>
									<a
										id="link-yun-xing-shi-li-job"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#yun-xing-shi-li-job"
									>
										运行示例 Job
									</a>
								</li>
								
								<li>
									<a
										id="link-bian-xie-job-gui-yue"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#bian-xie-job-gui-yue"
									>
										编写 Job 规约
									</a>
								</li>
								
								<li>
									<a
										id="link-chu-li-pod-he-rong-qi-shi-xiao"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#chu-li-pod-he-rong-qi-shi-xiao"
									>
										处理 Pod 和容器失效
									</a>
								</li>
								
								<li>
									<a
										id="link-job-zhong-zhi-yu-qing-li"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#job-zhong-zhi-yu-qing-li"
									>
										Job 终止与清理
									</a>
								</li>
								
								<li>
									<a
										id="link-zi-dong-qing-li-wan-cheng-de-job"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#zi-dong-qing-li-wan-cheng-de-job"
									>
										自动清理完成的 Job
									</a>
								</li>
								
								<li>
									<a
										id="link-job-mo-shi"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#job-mo-shi"
									>
										Job 模式
									</a>
								</li>
								
								<li>
									<a
										id="link-gao-ji-yong-fa"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#gao-ji-yong-fa"
									>
										高级用法
									</a>
								</li>
								
								<li>
									<a
										id="link-JobsAlternatives"
										class="toc is-size-7"
										href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#JobsAlternatives"
									>
										替代方案
									</a>
								</li>
								
							</ul>
							
						</li>
						
						<li>
							<a
								id="link-yi-wan-cheng-jobs-de-zi-dong-qing-li"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#yi-wan-cheng-jobs-de-zi-dong-qing-li"
							>
								已完成 Jobs 的自动清理
							</a>
							
						</li>
						
						<li>
							<a
								id="link-cronjob"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#cronjob"
							>
								CronJob
							</a>
							
						</li>
						
						<li>
							<a
								id="link-replicationcontroller"
								class="toc is-size-7 "
								href="https://jacobbishopxy.github.io/reads/2022-8-15-k8s-notes-iv-b/#replicationcontroller"
							>
								ReplicationController
							</a>
							
						</li>
						
					</ul>
				</aside>
			</div>
			
		</div>
	</div>
</section>
 
		<section class="modal" id="search-modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head">
					<p class="modal-card-title">Search</p>
				</header>
				<section class="modal-card-body">
					<div class="field mb-2">
						<div class="control">
							<input
								class="input"
								id="search"
								placeholder="Search this website."
								type="search"
							/>
						</div>
					</div>
					<div class="search-results">
						<div class="search-results__items"></div>
					</div>
				</section>
			</div>
			<button aria-label="close" class="modal-close is-large"></button>
		</section>
		      
		<footer class="footer py-4">
			<div class="content has-text-centered">
				<p>Who drives me forward like fate? The myself striding on my back.</p>
				<p>
					Powered by
					<span class="icon-text">
						<span class="icon">
							<i class="fas fa-power-off"></i>
						</span>
						<a href="https://www.getzola.org">zola</a>
					</span>
				</p>
			</div>
		</footer>
		    
		<script src="https://jacobbishopxy.github.io/elasticlunr.min.js"></script>
		<script src="https://jacobbishopxy.github.io/search_index.en.js"></script><script src="https://jacobbishopxy.github.io/js/site.js"></script>

		   
	</body>
</html>
