+++
title="K8s 笔记 (V)"
description="服务，负载均衡和网络"
date=2022-09-01

[taxonomies]
categories = ["Doc"]
tags = ["k8s"]

[extra]
toc = true
+++

## 简介

### K8s 网络模型

每个在集群里的 `Pod` 都有其唯一的 IP 地址。这就意味着用户不需要显式的创建 `Pods` 直接的连接，同时几乎不用处理容器端口与主机端口的映射。这就创建了一个干净的，向后兼容的模型，从端口分配，命名，服务发现，负载均衡，应用配置和迁移的角度来看，`Pods` 可以被视为 VMs 或者物理主机。

对任何网络设施，k8s 强制要求下列基础需求（使得排除掉有意隔离网络的策略）：

- Pod 能够与其他节点上的 Pod 通信，且不需要网络地址转译（NAT）
- 节点上的代理（比如：系统守护进程，kubelet）可以和节点上的所有 Pod 通信

注意：这些支持 `Pods` 运行在主机网络（例如 Linux）的平台，当 pods 连接到一个节点的主机网络，它们仍然可以不使用 NAT 与其他所有节点的 pods 通信。

这个模型不仅不复杂，而且还和 k8s 的实现从虚拟机向容器平滑迁移的初衷相符，如果任务开始是在虚拟机中运行的，虚拟机有一个 IP，可以和项目中其他虚拟机通信。这里的模型是基本相同的。

k8s 的 IP 地址存在于 `Pod` 范围内 -- 容器共享它们的网络命名空间 -- 包括它们的 IP 地址和 MAC 地址。这就意味着 `Pod` 内的容器都可以通过 `localhost` 到达对方端口。这也就意味着 `Pod` 内的容器需要相互协调端口的使用，这和虚拟机中的进程相同，因此也被称为”一个 Pod 一个 IP“模型。

如何实现上述需求是使用的特定容器运行时的细节。

也可以在 `Node` 本身请求端口，并用这类端口转发到用户的 `Pod`（称之为主机端口），但这是一个很特殊的操作。转发方式如何实现也是容器运行时的细节。`Pod` 自己并不知道这些主机端口的存在。

k8s 网络解决四方面的问题：

- 一个 Pod 中的容器之间通过本地回路（loopback）通信。
- 集群网络在不同 pod 之间提供通信。
- 服务资源允许用户向外暴露 Pods 中运行的应用，用来支持来自于集群外部的访问。
- 可以使用服务来发布仅供集群内部使用的服务。

## 服务 Service

将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法。

使用 k8s，用户无需修改应用程序即可使用不熟悉的服务发现机制。k8s 为 Pod 提供自己的 IP 地址，并为一组 Pod 提供相同的 DNS 名，并且可以在它们之间进行负载均衡。

### 动机

k8s Pods 的创建与销毁用于匹配集群的期望状态。Pod 是非永久性的资源。如果使用 Deployment 来运行应用程序，则可以动态创建和销毁 Pod。

每个 Pod 都有自己的 IP 地址，但是在 Deployment 中，在同一时刻运行的 Pod 集合可能会稍后运行该应用程序的 Pod 集合不同。

这导致了一个问题：如果一组 Pod（称为“后端”）为集群内的其他 Pod（称为“前端”）提供功能，那么前端如何找出并跟踪要连接的 IP 地址，以便前端可以使用提供工作负载的后端部分？

进入*Services*。

### Service 资源

k8s 中 Service 定义了这样一种抽象：逻辑上的一组 Pod，一种可以访问它们的策略 -- 通常称为微服务。Service 所针对的 Pod 集合通常是通过选择算符来确定的。

例如，一个图片处理后端，运行了 3 个副本。这些副本是可以互换的 -- 前端不需要关心它们调用了哪个后端副本。然而组成这一组后端程序的 Pod 实际上可能会发生变化，前端客户端不应该也不需要直到，而且也不需要跟踪这一组后端的状态。

Service 定义的抽象能够解耦这种关联。

### 定义 Service

WIP

### 虚拟 IP 和 Service 代理

WIP

### 多端口 Service

WIP

### 选择自己的 IP 地址

WIP

### 流量策略

WIP

### 服务发现

WIP

### 无头服务

WIP

### 发布服务

WIP

### 不足

WIP

### 虚拟 IP 实施

WIP

### API 对象

WIP

## 使用拓扑键实现拓扑感知的流量路由

WIP

## Pod 与服务的 DNS

WIP

## 使用服务连接到应用

### k8s 连接容器的模型

WIP

### 在集群中暴露 Pod

WIP

### 创建 Service

WIP

### 访问 Service

WIP

### 保护 Service

WIP

### 暴露 Service

WIP

## Ingress

**特性状态**：`v1.19 [stable]`

Ingress 时对集群中服务的外部访问进行管理的 API 对象，典型的访问方式是 HTTP。

Ingress 可以提供负载均衡，SSL 终结和基于名称的虚拟托管。

### 术语

WIP

### Ingress 是什么

WIP

### Ingress 资源

WIP

### 主机名通配符

WIP

### Ingress 类

WIP

### Ingress 类型

WIP

### 更新 Ingress

WIP

### 跨可用区失败

WIP

### 替代方案

WIP

## Ingress 控制器

WIP

## 端点切片

WIP

## 服务内部流量策略

WIP

## 拓扑感知提示

WIP

## 网络策略

WIP

## IPv4/IPv6 双协议栈

WIP
